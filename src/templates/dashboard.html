<!DOCTYPE html>
<html>
<head>
    <title>Phishing Detection Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #ffffff;
        }

        /* ===== TOP BAR ===== */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .right-controls {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        /* ===== MODEL SELECTOR ===== */
        .model-selector {
            background: linear-gradient(135deg, #eef2f7, #ffffff);
            border: 1px solid #cfd6df;
            border-radius: 22px;
            padding: 6px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .model-selector label {
            font-size: 13px;
            font-weight: bold;
        }

        .model-selector select {
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
        }

        /* ===== SOC BUTTON ===== */
        .soc-btn {
            padding: 8px 14px;
            background: #b30000;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
        }

        /* ===== LAYOUT ===== */
        .row {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
        }

        /* ===== PIE ===== */
        .chart-container {
            width: 220px;
            margin: auto;
            position: relative;
        }

        .chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        /* ===== TABLE ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            font-size: 14px;
        }

        th {
            background: #f1f1f1;
        }

        tr:hover {
            background: #f5f5f5;
        }

        tr {
            cursor: pointer;
        }

        .phishing {
            color: red;
            font-weight: bold;
        }

        .legit {
            color: green;
            font-weight: bold;
        }

        /* ===== FILTER ===== */
        .filter-box {
            margin-bottom: 10px;
        }

        /* ===== PAGINATION ===== */
        .pagination {
            text-align: center;
            margin-top: 10px;
        }

        .pagination button {
            padding: 5px 9px;
            margin: 3px;
            cursor: pointer;
        }

        /* ===== MODAL ===== */
        #emailModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }

        #modalBox {
            background: #fff;
            width: 70%;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            max-height: 80%;
            overflow-y: auto;
        }
    </style>
</head>

<body>

<!-- ================= TOP BAR ================= -->
<div class="top-bar">
    <h2>ðŸ“§ Phishing Detection Dashboard</h2>

    <div class="right-controls">
        <form method="get" class="model-selector">
            <label>Model</label>
            <select name="model" onchange="this.form.submit()">
                <option value="baseline" {{ "selected" if model=="baseline" }}>Baseline</option>
                <option value="xgboost" {{ "selected" if model=="xgboost" }}>XGBoost</option>
            </select>
        </form>

        <a href="/soc?model={{ model }}" class="soc-btn">
            ðŸš¨ SOC Alerts ({{ soc_alert_count }})
        </a>
    </div>
</div>

<!-- ================= PIE + TOP PHISHING ================= -->
<div class="row">

    <!-- PIE -->
    <div class="card">
        <h3>Email Classification</h3>
        <div class="chart-container">
            <canvas id="pie"></canvas>
            <div class="chart-center">
                <div style="font-size:20px; font-weight:bold;">
                    {{ total_emails }}
                </div>
                <div style="font-size:12px;">Total Emails</div>
                <div style="font-size:11px; margin-top:6px; color:#b30000;">
                    {{ phishing_count }} Phishing
                </div>
            </div>
        </div>
    </div>

    <!-- TOP PHISHING -->
    <div class="card">
        <h3>ðŸš¨ Top Phishing Emails</h3>
        <table>
            <tr><th>Sender</th><th>Subject</th><th>Probability</th></tr>
            {% for e in top_phishing %}
            <tr onclick="openEmail(
                `{{ e.subject | escape }}`,
                `{{ e.sender | escape }}`,
                `{{ e.date | escape }}`,
                `{{ e.final_label }}`,
                `{{ (e.phishing_probability * 100) | round(2) }}%`,
                `{{ e.cleaned_body | escape }}`
            )">
                <td>{{ e.sender }}</td>
                <td>{{ e.subject }}</td>
                <td>{{ (e.phishing_probability * 100) | round(2) }}%</td>
            </tr>
            {% endfor %}
        </table>
    </div>

</div>

<!-- ================= ALL EMAILS ================= -->
<div class="card" style="margin-top:20px;">
    <h3>ðŸ“¬ All Emails</h3>

    <div class="filter-box">
        <label><b>Filter:</b></label>
        <select id="labelFilter" onchange="applyFilter()">
            <option value="All">All</option>
            <option value="Phishing">Phishing</option>
            <option value="Legitimate">Legitimate</option>
        </select>
    </div>

    <table>
        <tr>
            <th>Mailbox</th>
            <th>Sender</th>
            <th>Date</th>
            <th>Subject</th>
            <th>Label</th>
            <th>Prob</th>
        </tr>

        {% for e in emails %}
        <tr class="email-row"
            data-label="{{ e.final_label }}"
            onclick="openEmail(
                `{{ e.subject | escape }}`,
                `{{ e.sender | escape }}`,
                `{{ e.date | escape }}`,
                `{{ e.final_label }}`,
                `{{ (e.phishing_probability * 100) | round(2) }}%`,
                `{{ e.cleaned_body | escape }}`
            )">
            <td>{{ e.mailbox }}</td>
            <td>{{ e.sender }}</td>
            <td>{{ e.date }}</td>
            <td>{{ e.subject }}</td>
            <td class="{{ 'phishing' if 'Phishing' in e.final_label else 'legit' }}">
                {{ e.final_label }}
            </td>
            <td>{{ (e.phishing_probability * 100) | round(2) }}%</td>
        </tr>
        {% endfor %}
    </table>

    <div class="pagination" id="pagination"></div>
</div>

<!-- ================= MODAL ================= -->
<div id="emailModal">
    <div id="modalBox">
        <h3 id="mSubject"></h3>
        <p><b>From:</b> <span id="mSender"></span></p>
        <p><b>Date:</b> <span id="mDate"></span></p>
        <p><b>Label:</b> <span id="mLabel"></span></p>
        <p><b>Probability:</b> <span id="mProb"></span></p>
        <hr>
        <pre id="mBody" style="white-space:pre-wrap;"></pre>
        <button onclick="closeModal()">Close</button>
    </div>
</div>

<script>
/* ===== PIE ===== */
new Chart(document.getElementById("pie"), {
    type: "doughnut",
    data: {
        labels: ["Phishing", "Legitimate"],
        datasets: [{
            data: [{{ phishing_count }}, {{ legit_count }}],
            backgroundColor: ["#ff4d4d", "#4CAF50"]
        }]
    },
    options: {
        cutout: "70%",
        plugins: { legend: { position: "bottom" } }
    }
});

/* ===== MODAL ===== */
function openEmail(subject, sender, date, label, prob, body) {
    document.getElementById("mSubject").innerText = subject;
    document.getElementById("mSender").innerText = sender;
    document.getElementById("mDate").innerText = date;
    document.getElementById("mLabel").innerText = label;
    document.getElementById("mProb").innerText = prob;
    document.getElementById("mBody").innerText = body;
    document.getElementById("emailModal").style.display = "block";
}

function closeModal() {
    document.getElementById("emailModal").style.display = "none";
}

/* ===== FILTER + PAGINATION ===== */
const rows = Array.from(document.querySelectorAll(".email-row"));
const perPage = 15;
let page = 1;
let filteredRows = rows;

function applyFilter() {
    const val = document.getElementById("labelFilter").value;
    filteredRows = rows.filter(r =>
        val === "All" || r.dataset.label.includes(val)
    );
    page = 1;
    render();
}

function render() {
    rows.forEach(r => r.style.display = "none");
    filteredRows.slice((page-1)*perPage, page*perPage)
        .forEach(r => r.style.display = "");
    renderPagination();
}

function renderPagination() {
    const p = document.getElementById("pagination");
    p.innerHTML = "";
    const total = Math.ceil(filteredRows.length / perPage);
    for (let i = 1; i <= total; i++) {
        const b = document.createElement("button");
        b.innerText = i;
        if (i === page) b.style.fontWeight = "bold";
        b.onclick = () => { page = i; render(); };
        p.appendChild(b);
    }
}

render();
</script>

</body>
</html>
